// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. 用户表 (包含个人资料)
model User {
  id          String   @id @default(cuid())
  username    String   @unique
  password    String   // 加密存储 (bcrypt)
  createdAt   DateTime @default(now())
  
  // 个人资料
  nickname    String?
  avatarUrl   String?
  slogan      String?
  aboutMe     String?
  location    String?
  socialLinks String?  // 存 JSON: { github: "...", email: "..." }

  // 关联
  likes       Like[]   // 用户点赞记录
  posts       Post[]   // 用户发布的文章
  searchHistory SearchHistory[] // 搜索历史
  
  // 关注系统
  followedBy  Follow[] @relation("following") // 谁关注了我 (我的粉丝)
  following   Follow[] @relation("follower")  // 我关注了谁 (我的关注)

  // 通知系统
  notifications Notification[] @relation("user") // 收到的通知
  actions       Notification[] @relation("actor") // 发出的动作(产生的通知)
}

// 2. 站点动态配置表 (保留用于全站公告等，不再存个人信息)
model SiteConfig {
  id          Int      @id @default(1)
  siteName    String   @default("MySpace")
  footerText  String?
}

// 3. 文章表
model Post {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  coverImage  String?
  published   Boolean  @default(false)
  pinned      Boolean  @default(false)

  tags        String? 
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  comments    Comment[]
  likes       Like[]
  likeCount   Int       @default(0)

  // 关联作者
  author      User?     @relation(fields: [authorId], references: [id])
  authorId    String?   // 暂时可选，兼容旧数据
  
  attachments Attachment[] // 关联附件
  notifications Notification[] // 关联通知
}

// 6. 附件表
model Attachment {
  id        String   @id @default(cuid())
  url       String
  filename  String
  fileType  String?  // image/png, application/pdf etc
  size      Int?     // bytes
  createdAt DateTime @default(now())

  post      Post?    @relation(fields: [postId], references: [id])
  postId    String?  // 可选，如果是上传完还没发文章，这里可以为空
}

// 4. 评论表
model Comment {
  id        String   @id @default(cuid())
  nickname  String   // 访客昵称
  content   String   // 评论内容
  isAdmin   Boolean  @default(false) // 是否是博主回复
  isApproved Boolean @default(false) // 审核状态：false=待审, true=公开

  createdAt DateTime @default(now())

  // 关联文章
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  // 支持简单的嵌套回复 (父子评论)
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")

  notifications Notification[] // 关联通知
}

// 5. 点赞表
model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@unique([postId, userId])
}

// 7. 搜索历史表
model SearchHistory {
  id        String   @id @default(cuid())
  query     String   // 搜索的关键词 (用户名)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@unique([userId, query]) 
}

// 8. 关注表 (多对多)
model Follow {
  id          String   @id @default(cuid())
  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  followerId  String
  
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  followingId String

  createdAt   DateTime @default(now())

  @@unique([followerId, followingId]) // 防止重复关注
}

// 9. 通知表 (新增)
model Notification {
  id        String   @id @default(cuid())
  type      String   // COMMENT, LIKE, FOLLOW
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // 接收者
  user      User     @relation("user", fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  // 触发者 (actor)
  actor     User?    @relation("actor", fields: [actorId], references: [id])
  actorId   String?  // 可选，如果是访客评论则无 actor

  // 关联实体
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String?

  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?
}
